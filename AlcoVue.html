<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue Alcohol Unit Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .calc-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .calc-section h3 {
            margin-top: 0;
            color: #856404;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        button:hover {
            background: #1e7e34;
        }
        
        .calc-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .calc-btn:hover {
            background: #e0a800;
        }
        
        .export-btn {
            background: #17a2b8;
        }
        
        .export-btn:hover {
            background: #138496;
        }
        
        .reset-btn {
            background: #dc3545;
        }
        
        .reset-btn:hover {
            background: #c82333;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:hover {
            background-color: #d4edda;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            min-width: 0;
        }
        
        .stat-card.warning {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #155724;
        }
        
        .stat-value.warning {
            color: #721c24;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .warning-text {
            color: #721c24;
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .input-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .input-group {
                min-width: auto;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            h1 {
                font-size: 24px;
                text-align: center;
            }
            
            th, td {
                padding: 8px 4px;
                font-size: 14px;
            }
            
            .delete-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .input-section, .calc-section {
                padding: 10px;
            }
            
            th, td {
                padding: 6px 3px;
                font-size: 12px;
            }
            
            .stat-value {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>Alcohol Unit Tracker</h1>
            
            <div class="loading" v-if="loading">
                Loading your data...
            </div>
            
            <template v-else>
                <drink-form 
                    @drink-added="addDrink"
                    :is-saving="isSaving">
                </drink-form>
                
                <drink-stats 
                    :drinks="drinks"
                    v-if="drinks.length > 0">
                </drink-stats>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="export-btn" @click="exportToCSV" :disabled="drinks.length === 0">
                        Export CSV
                    </button>
                    <button class="reset-btn" @click="resetAllData" :disabled="drinks.length === 0">
                        Reset All Data
                    </button>
                </div>
                
                <drinks-table 
                    :drinks="drinks"
                    @delete-drink="deleteDrink">
                </drinks-table>
            </template>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // *** REPLACE THESE WITH YOUR SUPABASE DETAILS ***
        const SUPABASE_URL = 'https://sfsnhbdxqvzerrvpaxhj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmc25oYmR4cXZ6ZXJydnBheGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODE3OTMsImV4cCI6MjA3MjY1Nzc5M30.b0T-kTofmI-86HGYwgXAaO6pYje57dCbzK5gIyhexfE';
        
        // Drink Form Component
        const DrinkForm = {
            props: ['isSaving'],
            emits: ['drink-added'],
            setup(props, { emit }) {
                const date = ref(new Date().toISOString().split('T')[0]);
                const drinkName = ref('');
                const units = ref('');
                const volume = ref('');
                const abv = ref('');

                const calculateUnits = () => {
                    const vol = parseFloat(volume.value);
                    const abvVal = parseFloat(abv.value);
                    
                    if (isNaN(vol) || isNaN(abvVal) || vol <= 0 || abvVal <= 0) {
                        alert("Please enter valid volume and ABV.");
                        return;
                    }
                    
                    const calculatedUnits = (vol * abvVal) / 1000;
                    units.value = calculatedUnits.toFixed(2);
                };

                const addDrink = () => {
                    if (!date.value) {
                        alert('Please select a date');
                        return;
                    }
                    
                    const unitsValue = parseFloat(units.value);
                    if (isNaN(unitsValue) || unitsValue <= 0) {
                        alert("Please enter units directly or calculate from volume & ABV.");
                        return;
                    }

                    const drink = {
                        date: date.value,
                        name: drinkName.value || "Unnamed drink",
                        units: unitsValue
                    };

                    emit('drink-added', drink);
                    
                    // Clear form
                    drinkName.value = '';
                    units.value = '';
                    volume.value = '';
                    abv.value = '';
                };

                return {
                    date,
                    drinkName,
                    units,
                    volume,
                    abv,
                    calculateUnits,
                    addDrink
                };
            },
            template: `
                <div class="input-section">
                    <div class="input-row">
                        <div class="input-group">
                            <label for="date">Date:</label>
                            <input type="date" v-model="date" id="date">
                        </div>
                        <div class="input-group">
                            <label for="drinkName">Drink Name:</label>
                            <input type="text" v-model="drinkName" id="drinkName" placeholder="e.g. Pint of beer">
                        </div>
                        <div class="input-group">
                            <label for="units">Units (if known):</label>
                            <input type="number" v-model="units" id="units" step="0.1" placeholder="e.g. 2.3" min="0">
                        </div>
                    </div>
                    
                    <div class="calc-section">
                        <h3>OR Calculate from Volume & ABV:</h3>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="volume">Volume (ml):</label>
                                <input type="number" v-model="volume" id="volume" step="1" placeholder="e.g. 175" min="0">
                            </div>
                            <div class="input-group">
                                <label for="abv">ABV (%):</label>
                                <input type="number" v-model="abv" id="abv" step="0.1" placeholder="e.g. 13" min="0">
                            </div>
                            <div class="button-group">
                                <button class="calc-btn" @click="calculateUnits">Calculate Units</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button @click="addDrink" :disabled="isSaving">
                            {{ isSaving ? 'Adding...' : 'Add Drink' }}
                        </button>
                    </div>
                </div>
            `
        };

        // Stats Component
        const DrinkStats = {
            props: ['drinks'],
            setup(props) {
                const todayUnits = computed(() => {
                    const today = new Date().toISOString().split('T')[0];
                    return props.drinks
                        .filter(d => d.date === today)
                        .reduce((sum, d) => sum + d.units, 0);
                });

                const weekUnits = computed(() => {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return props.drinks
                        .filter(d => new Date(d.date) >= weekAgo)
                        .reduce((sum, d) => sum + d.units, 0);
                });

                const avgDaily = computed(() => weekUnits.value / 7);

                const isWeeklyWarning = computed(() => weekUnits.value >= 14);
                const isDailyWarning = computed(() => todayUnits.value >= 4);

                return {
                    todayUnits,
                    weekUnits,
                    avgDaily,
                    isWeeklyWarning,
                    isDailyWarning,
                    totalDrinks: computed(() => props.drinks.length)
                };
            },
            template: `
                <div>
                    <div class="stats">
                        <div class="stat-card" :class="{ warning: isDailyWarning }">
                            <div class="stat-value" :class="{ warning: isDailyWarning }">
                                {{ todayUnits.toFixed(1) }}
                            </div>
                            <div class="stat-label">Today's Units</div>
                        </div>
                        <div class="stat-card" :class="{ warning: isWeeklyWarning }">
                            <div class="stat-value" :class="{ warning: isWeeklyWarning }">
                                {{ weekUnits.toFixed(1) }}
                            </div>
                            <div class="stat-label">This Week's Units</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ avgDaily.toFixed(1) }}</div>
                            <div class="stat-label">Avg Daily (7 days)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ totalDrinks }}</div>
                            <div class="stat-label">Total Drinks</div>
                        </div>
                    </div>
                    
                    <div v-if="isWeeklyWarning" class="warning-text">
                        ⚠️ You've exceeded the recommended weekly limit of 14 units!
                    </div>
                </div>
            `
        };

        // Table Component
        const DrinksTable = {
            props: ['drinks'],
            emits: ['delete-drink'],
            setup(props, { emit }) {
                const formatDate = (dateString) => {
                    return new Date(dateString).toLocaleDateString('en-GB');
                };

                const deleteDrink = (id) => {
                    if (confirm('Are you sure you want to delete this drink?')) {
                        emit('delete-drink', id);
                    }
                };

                return {
                    formatDate,
                    deleteDrink
                };
            },
            template: `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Drink Name</th>
                                <th>Units</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="drink in drinks" :key="drink.id">
                                <td>{{ formatDate(drink.date) }}</td>
                                <td>{{ drink.name }}</td>
                                <td>{{ drink.units.toFixed(1) }}</td>
                                <td>
                                    <button class="delete-btn" @click="deleteDrink(drink.id)">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `
        };

        // Main App
        const { createApp } = Vue;
        
        createApp({
            components: {
                DrinkForm,
                DrinkStats,
                DrinksTable
            },
            setup() {
                const drinks = ref([]);
                const loading = ref(true);
                const isSaving = ref(false);
                let supabase;

                const initSupabase = async () => {
                    try {
                        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        await loadDrinks();
                    } catch (error) {
                        console.error('Error initializing Supabase:', error);
                        alert('Error connecting to database. Please check your Supabase configuration.');
                        loading.value = false;
                    }
                };

                const loadDrinks = async () => {
                    try {
                        const { data, error } = await supabase
                            .from('alcohol_drinks')
                            .select('*')
                            .order('drink_date', { ascending: false });
                        
                        if (error) throw error;
                        
                        drinks.value = data.map(row => ({
                            id: row.id,
                            date: row.drink_date,
                            name: row.drink_name,
                            units: row.units
                        }));
                    } catch (error) {
                        console.error('Error loading drinks:', error);
                        alert('Error loading data: ' + error.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const addDrink = async (drink) => {
                    isSaving.value = true;
                    try {
                        const { data, error } = await supabase
                            .from('alcohol_drinks')
                            .insert([
                                {
                                    drink_date: drink.date,
                                    drink_name: drink.name,
                                    units: drink.units
                                }
                            ])
                            .select();
                        
                        if (error) throw error;
                        
                        // Add to local array
                        const newDrink = {
                            id: data[0].id,
                            date: drink.date,
                            name: drink.name,
                            units: drink.units
                        };
                        
                        drinks.value.unshift(newDrink);
                    } catch (error) {
                        console.error('Error adding drink:', error);
                        alert('Error saving drink: ' + error.message);
                    } finally {
                        isSaving.value = false;
                    }
                };

                const deleteDrink = async (id) => {
                    try {
                        const { error } = await supabase
                            .from('alcohol_drinks')
                            .delete()
                            .eq('id', id);
                        
                        if (error) throw error;
                        
                        drinks.value = drinks.value.filter(d => d.id !== id);
                    } catch (error) {
                        console.error('Error deleting drink:', error);
                        alert('Error deleting drink: ' + error.message);
                    }
                };

                const resetAllData = async () => {
                    if (!confirm("Clear all drinks? This will permanently delete all your data!")) {
                        return;
                    }
                    
                    try {
                        const { error } = await supabase
                            .from('alcohol_drinks')
                            .delete()
                            .gte('id', 0);
                        
                        if (error) throw error;
                        
                        drinks.value = [];
                    } catch (error) {
                        console.error('Error resetting data:', error);
                        alert('Error clearing data: ' + error.message);
                    }
                };

                const exportToCSV = () => {
                    if (drinks.value.length === 0) {
                        alert('No data to export');
                        return;
                    }
                    
                    const headers = ['Date', 'Drink Name', 'Units'];
                    const csvContent = [
                        headers.join(','),
                        ...drinks.value.map(d => [
                            d.date,
                            `"${d.name}"`,
                            d.units
                        ].join(','))
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'alcohol_consumption.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                };

                onMounted(initSupabase);

                return {
                    drinks,
                    loading,
                    isSaving,
                    addDrink,
                    deleteDrink,
                    resetAllData,
                    exportToCSV
                };
            }
        }).mount('#app');
    </script>
</body>
</html>